<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Captura Cámara + Flask + Cloudinary</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f7f8fb;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    video, canvas, img {
      max-width: 100%;
      border-radius: 10px;
      border: 2px solid #ccc;
      margin: 10px 0;
    }
    .btn {
      margin: 5px;
    }
    #preview img {
      max-width: 100%;
      margin-top: 15px;
      border: 2px solid #4CAF50;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h1 class="mb-4">📷 Captura y Subida a Cloudinary</h1>
  
  <video id="video" autoplay playsinline class="shadow"></video>
  <canvas id="canvas" style="display:none;"></canvas>
  
  <div class="mt-3">
    <button id="capture" class="btn btn-primary">📸 Capturar</button>
    <button id="upload" class="btn btn-success" disabled>☁️ Subir a Cloudinary</button>
    <button id="list" class="btn btn-secondary">📥 Descargar Imágenes</button>
  </div>

  <div id="preview" class="mt-4"></div>
  <div id="gallery" class="mt-4"></div>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const captureBtn = document.getElementById("capture");
    const uploadBtn = document.getElementById("upload");
    let capturedBlob = null;

    // 🚀 Acceso a la cámara
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => { video.srcObject = stream; });

    // 🚀 Capturar imagen
    captureBtn.addEventListener("click", () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      canvas.toBlob((blob) => {
        capturedBlob = blob;
        const img = document.createElement("img");
        img.src = URL.createObjectURL(blob);
        document.getElementById("preview").innerHTML = "";
        document.getElementById("preview").appendChild(img);

        uploadBtn.disabled = false; // activar botón de subida
      }, "image/jpeg");
    });

    // 🚀 Subir a Cloudinary (vía Flask)
    uploadBtn.addEventListener("click", async () => {
      if (!capturedBlob) return alert("Primero captura una imagen.");

      const formData = new FormData();
      formData.append("file", capturedBlob);

      uploadBtn.textContent = "⏳ Subiendo...";
      uploadBtn.disabled = true;

      const res = await fetch("/upload", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      console.log(data);

      if (data.secure_url) {
        const img = document.createElement("img");
        img.src = data.secure_url;
        document.getElementById("preview").innerHTML = `<h5>✅ Subida a Cloudinary</h5>`;
        document.getElementById("preview").appendChild(img);
      } else {
        alert("❌ Error al subir la imagen.");
      }

      uploadBtn.textContent = "☁️ Subir a Cloudinary";
    });

    const listBtn = document.getElementById("list");

    // 🚀 Función para descargar una sola imagen
    async function downloadImage(url, filename) {
      const response = await fetch(url);
      const blob = await response.blob();
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename; // nombre del archivo
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // 🚀 Función para descargar todas las imágenes visibles
    async function downloadAll(urls) {
      for (let i = 0; i < urls.length; i++) {
        await downloadImage(urls[i], `imagen_${i+1}.jpg`);
      }
    }

    // 🚀 Botón para listar imágenes
    listBtn.addEventListener("click", async () => {
      const res = await fetch("/list");
      const urls = await res.json();

      const gallery = document.getElementById("gallery");
      gallery.innerHTML = "<h4>📂 Imágenes almacenadas</h4>";

      urls.forEach((url, idx) => {
        const container = document.createElement("div");
        container.className = "mb-3";

        const img = document.createElement("img");
        img.src = url;
        img.style.maxWidth = "200px";
        img.style.margin = "5px";
        img.style.borderRadius = "8px";
        img.style.border = "1px solid #ddd";

        const btn = document.createElement("button");
        btn.textContent = "⬇️ Descargar";
        btn.className = "btn btn-outline-primary m-2";
        btn.onclick = () => downloadImage(url, `imagen_${idx+1}.jpg`);

        container.appendChild(img);
        container.appendChild(document.createElement("br"));
        container.appendChild(btn);
        gallery.appendChild(container);
      });

      // 🚀 Botón "Descargar todas"
      const downloadAllBtn = document.createElement("button");
      downloadAllBtn.textContent = "⬇️ Descargar TODAS";
      downloadAllBtn.className = "btn btn-danger mt-3";
      downloadAllBtn.onclick = () => downloadAll(urls);

      gallery.appendChild(downloadAllBtn);
    });

  </script>
</body>
</html>
